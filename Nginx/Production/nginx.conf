# Significa que o Nginx irá executar como usuário www-data.
#
# Defines user and group credentials used by worker processes.
# If group is omitted, a group whose name equals that of user is used.
#
# (Default: user nobody nobody;)
# (Context: main)
user www-data; # {nginx}

# Defines the number of worker processes.
#
# The optimal value depends on many factors including (but not limited to) the number of CPU cores, the number of hard disk drives that store data, and load pattern.
# When one is in doubt, setting it to the number of available CPU cores would be a good start (the value “auto” will try to autodetect it).
# One worker process per CPU core.
#
# You must set worker processes based on your CPU cores, nginx does not benefit from setting more than that.
#
# (Default: worker_processes 1;)
# (Context: main)
worker_processes auto;

# Defines a file that will store the process ID of the main process.
#
# (Default: pid logs/nginx.pid;)
# (Context: main)
pid /var/run/nginx.pid;

# Also set
# /etc/security/limits.conf
#   www-data soft nofile 50000
#   www-data hard nofile 100000
# /etc/default/nginx
#     ULIMIT="-n 100000"
#
# Changes the limit on the maximum number of open files (RLIMIT_NOFILE) for worker processes.
# Used to increase the limit without restarting the main process.
#
# Number of file descriptors used for nginx the limit for the maximum FDs on the server is usually set by the OS.
#
# (Default: —)
# (Context: main)
worker_rlimit_nofile 100000;

# Provides the configuration file context in which the directives that affect connection processing are specified.
events {

    # The formula for maximum number of connections we can handle then becomes:
    #   worker_processes * worker_connections * (K / average $request_time)
    #       Where K is the amount of currently active connections.
    #       Additionally, for the value K, we also have to consider reverse proxying which will open up an additional connection to your backend.

    # Define o número máximo de conexões simultâneas que podem ser abertas por um processo de trabalho.
    #
    # Determines how many clients will be served by each worker process.
    # Sets the maximum number of simultaneous connections that can be opened by a worker process.
    #
    # Should be equal to `ulimit -n`.
    #
    # worker_connections não pode exceder worker_rlimit_nofile se configurado.
    # the actual number of simultaneous connections cannot exceed the current limit on the maximum number of open files, which can be changed by worker_rlimit_nofile.
    #
    # max clients is also limited by the number of socket connections available on the system (~64k)
    #
    # (Default: worker_connections 512;)
    # (Context: events)
    worker_connections 6000;

    # Let each process accept multiple connections.
    #
    # Accept as many connections as possible, after nginx gets notification about a new connection.
    #
    # If multi_accept is disabled, a worker process will accept one new connection at a time.
    # Otherwise, a worker process will accept all new connections at a time.
    #
    # (Default: multi_accept off;)
    # (Context: events)
    multi_accept on;

    # Preferred connection method for newer linux versions.
    #
    # Essential for linux, optmized to serve many clients with each thread.
    #
    # Specifies the connection processing method to use.
    # There is normally no need to specify it explicitly, because nginx will by default use the most efficient method.
    #
    # (Default: —)
    # (Context: events)
    use epoll;
}

http {

    ## [MIME types]
    include mime.types;

    ################
    # Basic Settings
    ################

    # Sets the maximum size of the types hash tables.
    # The details of setting up hash tables are provided in a separate [document](http://nginx.org/en/docs/hash.html).
    #
    # (Default: types_hash_max_size 1024;)
    # (Context: http, server, location)
    types_hash_max_size 2048;

    # Enables or disables emitting nginx version on error pages and in the “Server” response header field.
    # Don't send the nginx version number in error pages and Server header.
    #
    # (Default: server_tokens on;)
    # (Context: http, server, location)
    server_tokens off;

    # Defines files that will be used as an index.
    # The file name can contain variables.
    # Files are checked in the specified order.
    # The last element of the list can be a file with an absolute path.
    #
    # (Default: index index.html;)
    # (Context: http, server, location)
    index index.html index.php;

    # Defines the default MIME type of a response.
    # Mapping of file name extensions to MIME types can be set with the types directive.
    #
    # (Default: default_type text/plain;)
    # (Context: http, server, location)
    default_type application/octet-stream;

    # Adds the specified charset to the “Content-Type” response header field.
    # If this charset is different from the charset specified in the source_charset directive, a conversion is performed.
    #
    # (Default: charset off;)
    # (Context: http, server, location, if in location)
    charset UTF-8;

    ##################
    # Logging Settings
    ##################

    # log_format  main '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    # Sets the path, format, and configuration for a buffered log write.
    # Several logs can be specified on the same level.
    # Logging to syslog can be configured by specifying the “syslog:” prefix in the first parameter.
    # The special value off cancels all access_log directives on the current level.
    # If the format is not specified then the predefined “combined” format is used.
    # To boost I/O on HDD we can disable access logs
    #
    # (Default: access_log logs/access.log combined;)
    # (Context: http, server, location, if in location, limit_except)
    access_log off;

    # Configures logging.
    # Several logs can be specified on the same level.
    # If on the main configuration level writing a log to a file is not explicitly defined, the default file will be used.
    #
    # The second parameter determines the level of logging, and can be one of the following: debug, info, notice, warn, error, crit, alert, or emerg.
    # Log levels above are listed in the order of increasing severity.
    # Setting a certain log level will cause all messages of the specified and more severe log levels to be logged.
    # For example, the default level error will cause error, crit, alert, and emerg messages to be logged.
    # If this parameter is omitted then error is used.
    #
    # (Default: error_log logs/error.log error;)
    # (Context: main, http, mail, stream, server, location)
    error_log /var/log/nginx/error.log warn;

    #############
    # Size Limits
    #############

    # Sets buffer size for reading client request body.
    # In case the request body is larger than the buffer, the whole body or only its part is written to a temporary file.
    # By default, buffer size is equal to two memory pages.
    # This is 8K on x86, other 32-bit platforms, and x86-64.
    # It is usually 16K on other 64-bit platforms.
    #
    # (Default: client_body_buffer_size 8k|16k;)
    # (Context: http, server, location)
    client_body_buffer_size 128k;

    # Sets buffer size for reading client request header.
    # For most requests, a buffer of 1K bytes is enough.
    # However, if a request includes long cookies, or comes from a WAP client, it may not fit into 1K.
    # If a request line or a request header field does not fit into this buffer then larger buffers, configured by the large_client_header_buffers directive, are allocated.
    #
    # (Default: client_header_buffer_size 1k;)
    # (Context: http, server)
    client_header_buffer_size 16k;

    # Sets the maximum allowed size of the client request body, specified in the “Content-Length” request header field.
    # If the size in a request exceeds the configured value, the 413 (Request Entity Too Large) error is returned to the client.
    # Please be aware that browsers cannot correctly display this error.
    # Setting size to 0 disables checking of client request body size.
    #
    # (Default: client_max_body_size 1m;)
    # (Context: http, server, location)
    client_max_body_size 32k;

    # Sets the maximum number and size of buffers used for reading large client request header.
    # A request line cannot exceed the size of one buffer, or the 414 (Request-URI Too Large) error is returned to the client.
    # A request header field cannot exceed the size of one buffer as well, or the 400 (Bad Request) error is returned to the client.
    # Buffers are allocated only on demand. By default, the buffer size is equal to 8K bytes.
    # If after the end of request processing a connection is transitioned into the keep-alive state, these buffers are released.
    #
    # (Default: large_client_header_buffers 4 8k;)
    # (Context: http, server)
    large_client_header_buffers 4 256k;

    # Allow the server to close the connection after a client stops responding.
    # Frees up socket-associated memory.
    #
    # Enables or disables resetting timed out connections.
    #
    # It should be noted that timed out keep-alive connections are closed normally.
    #
    # Allow the server to close connection on non responding client, this will free up memory.
    # Deflect DDoS.
    #
    # (Default: reset_timedout_connection off;)
    # (Context: http, server, location)
    reset_timedout_connection on;

    ##########
    # Timeouts
    ##########
    # Timeouts, do not keep connections open longer then necessary to reduce resource usage and deny Slowloris type attacks.

    # Defines a timeout for reading client request body.
    # The timeout is set only for a period between two successive read operations, not for the transmission of the whole request body.
    # If a client does not transmit anything within this time, the 408 (Request Time-out) error is returned to the client.
    #
    # (Default: client_body_timeout 60s;)
    # (Context: http, server, location)
    client_body_timeout 10s;

    # Defines a timeout for reading client request header.
    # If a client does not transmit the entire header within this time, the 408 (Request Time-out) error is returned to the client.
    #
    # (Default: client_header_timeout 60s;)
    # (Context: http, server)
    client_header_timeout 10s;

    # Define um limite de tempo durante o qual uma conexão de cliente keep-alive vai ficar aberta no servidor.
    #     O valor zero desativa conexões keep-alive com cliente.
    #
    # The author of nginx claims that 10,000 idle connections will use only 2.5 MB of memory, and from what I’ve seen this seems to be correct.
    #
    # Sets a timeout during which a keep-alive client connection will stay open on the server side.
    # The zero value disables keep-alive client connections.
    #
    # The keepalive_timeout assigns the timeout for keep-alive connections with the client.
    # Simply put, Nginx will close connections with the client after this period of time.
    #
    # Keepalive connections allow to reuse the same TCP connection for multiple HTTP requests.
    #
    # (Default: keepalive_timeout 75s;)
    # (Context: http, server, location)
    keepalive_timeout 10;

    # Sets the maximum number of requests that can be served through one keep-alive connection.
    # After the maximum number of requests are made, the connection is closed.
    # Number of requests client can make over keep-alive.
    #
    # (Default: keepalive_requests 100;)
    # (Context: http, server, location)
    keepalive_requests 100;

    # Sets a timeout for transmitting a response to the client.
    # The timeout is set only between two successive write operations, not for the transmission of the whole response.
    # If the client does not receive anything within this time, the connection is closed.
    #
    # (Default: send_timeout 60s;)
    # (Context: http, server, location)
    send_timeout 10s;

    #######################
    # Open File Descriptors
    #######################
    # Caches information about open FDs, freqently accessed files.

    # Configures a cache that can store:
    #   open file descriptors, their sizes and modification times;
    #   information on existence of directories;
    #   file lookup errors, such as “file not found”, “no read permission”, and so on.
    #
    # (Default: open_file_cache off;)
    # (Context: http, server, location)
    open_file_cache max=50000 inactive=1m;

    # Sets a time after which open_file_cache elements should be validated.
    #
    # (Default: open_file_cache_valid 60s;)
    # (Context: http, server, location)
    open_file_cache_valid 30s;

    # Sets the minimum number of file accesses during the period configured by the inactive parameter of the open_file_cache directive, required for a file descriptor to remain open in the cache.
    #
    # (Default: open_file_cache_min_uses 1;)
    # (Context: http, server, location)
    open_file_cache_min_uses 2;

    # Enables or disables caching of file lookup errors by open_file_cache.
    #
    # (Default: open_file_cache_errors off;)
    # (Context: http, server, location)
    open_file_cache_errors on;

    # Não bloqueia a saída e entrada do disco informando que os dados não estão na memória.
    #     Em seguida, o nginx inicia uma carga de dados assíncronos através da leitura de um byte.
    #
    # Sendfile copies data between one FD and other from within the kernel.
    # More efficient than read() + write(), since the requires transferring data to and from the user space.
    # Copies data between one FD and other from within the kernel faster then read() + write().
    #
    # (Default: sendfile off;)
    # Context: http, server, location, if in location)
    sendfile on;

    # When set to a non-zero value, limits the amount of data that can be transferred in a single sendfile() call.
    # Without the limit, one fast connection may seize the worker process entirely.
    #
    # (Default: sendfile_max_chunk 0;)
    # (Context: http, server, location)
    sendfile_max_chunk 1m;

    # Somente é usada quando o sendfile também está ativo.
    #     Pois, esta diretiva é reponsável por enviar o cabeçalho de resposta de pacotes para o sistema operacional.
    #
    # Tcp_nopush causes nginx to attempt to send its HTTP response head in one packet, instead of using partial frames.
    # This is useful for prepending headers before calling sendfile, or for throughput optimization.
    # Send headers in one peace, its better then sending them one by one.
    #
    # (Default: tcp_nopush off;)
    # (Context: http, server, location)
    tcp_nopush on;

    # Don't buffer data-sends (disable Nagle algorithm). Good for sending frequent small bursts of data in real time.
    #
    # Enables or disables the use of the TCP_NODELAY option.
    # The option is enabled only when a connection is transitioned into the keep-alive state.
    # Don't buffer data sent, good for small data bursts in real time.
    #
    # (Default: tcp_nodelay on;)
    # (Context: http, server, location)
    tcp_nodelay on;

    ###############
    # Gzip Settings
    # #############

    # Enables or disables gzipping of responses.
    #
    # (Default: gzip off;)
    # (Context: http, server, location, if in location)
    gzip on;

    # Disables gzipping of responses for requests with “User-Agent” header fields matching any of the specified regular expressions.
    #
    # (Default: —)
    # (Context: http, server, location)
    gzip_disable "msie6";

    # Enables or disables inserting the “Vary: Accept-Encoding” response header field if the directives gzip, gzip_static, or gunzip are active.
    #
    # (Default: gzip_vary off;)
    # (Context: http, server, location)
    gzip_vary on;

    # Enables or disables gzipping of responses for proxied requests depending on the request and response.
    # The fact that the request is proxied is determined by the presence of the “Via” request header field.
    #
    # (Default: gzip_proxied off;)
    # (Context: http, server, location)
    gzip_proxied any;

    # Sets a gzip compression level of a response. Acceptable values are in the range from 1 to 9.
    #
    # (Default: gzip_comp_level 1;)
    # (Context: http, server, location)
    gzip_comp_level 6;

    # Sets the minimum length of a response that will be gzipped.
    # The length is determined only from the “Content-Length” response header field.
    #
    # (Default: gzip_min_length 20;)
    # (Context: http, server, location)
    gzip_min_length 20;

    # Enables gzipping of responses for the specified MIME types in addition to “text/html”.
    # The special value “*” matches any MIME type.
    # Responses with the “text/html” type are always compressed.
    #
    # (Default: gzip_vary off;)
    # (Context: http, server, location)
    gzip_types
        text/plain
        text/css
        application/json
        application/x-javascript
        text/xml
        application/xml
        application/xml+rss
        text/javascript
        application/javascript
        text/x-js
        application/vnd.ms-fontobject
        application/x-font-ttf
        font/opentype
        image/svg+xml
        image/x-icon;

    ################
    ## BLOCK TOR IPS
    ################
    # wget -q https://www.dan.me.uk/torlist/ -O - | sed "s/^/deny /g; s/$/;/g" >> /etc/nginx/conf.d/deny_tor_ips.conf
    # wget -qO- https://check.torproject.org/exit-addresses | grep ExitAddress | cut -d ' ' -f 2 | sed "s/^/deny /g; s/$/;/g" >> /etc/nginx/conf.d/deny_tor_ips.conf
    # curl -u email@mail.com:jvfs696gs2 'https://secthemall.com/public-list/tor-exit-nodes/iplist?size=10000' | sed "s/^/deny /g; s/$/;/g" >> /etc/nginx/conf.d/deny_tor_ips.conf

    #############################
    ## Include Additional Configs
    #############################

    map $http_x_forwarded_proto $is_https {
        default off;
        https on;
    }

    # Security HTTP Headers
    include snippets/security_HTTP_headers.conf;

    # Block spammers and other unwanted visitors
    include snippets/blockips.conf;

    #####################
    ## Include All Vhosts
    #####################
    include servers/*;
}
