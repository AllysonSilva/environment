######
# Maps
# (Context: http)
######

map $http_origin $allow_cors {
    # Indicates all map values are hostnames and should be parsed as such
    hostnames;

    default 'false';

    # All your domains
    localhost 'true';
    allyson.tech 'true';
    www.allyson.tech 'true';
}

##########
## SERVERS
##########

##################
# Nginx virtual hosts (HTTPS-only)
##################

server {
    listen 80;
    listen [::]:80;

    server_name api.allyson.tech www.api.allyson.tech;

    include /etc/nginx/snippets/letsencrypt.conf;

    server_name_in_redirect off;
    port_in_redirect off;
    log_not_found off;

    location / {
        # Redirect all HTTP requests to HTTPS with a 301 Moved Permanently response
        return 301 https://api.allyson.tech$request_uri;
    }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name www.api.allyson.tech;

    server_name_in_redirect off;
    port_in_redirect off;
    log_not_found off;

    # include snippets/ssl_common_certificates.conf;
    # include snippets/ssl_best_practices.conf;

    return 301 https://api.allyson.tech$request_uri;
}

server {

    ######
    #### CONFIG
    ######

    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # Sets names of a virtual server.
    #
    # (Default: server_name "";)
    # (Context: server)
    server_name api.allyson.tech;

    # Configures logging
    error_log /var/log/nginx/api.allyson.tech.error.log warn;

    # Sets the root directory for requests.
    #
    # (Default: root html;)
    # (Context: http, server, location, if in location)
    root /var/www/api.allyson.tech/public;

    location / {
        # allow 1.2.3.4;
        deny all;

        try_files $uri $uri/ /index.php?$query_string =404;

        if ($allow_cors = 'true') {
            add_header 'Access-Control-Allow-Origin' "$http_origin" always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With' always;
            # required to be able to read Authorization header in frontend
            # add_header 'Access-Control-Expose-Headers' 'Authorization' always;
        }

        # Security HTTP Headers
        include snippets/security_HTTP_headers.conf;

        add_header Cache-Control "no-cache, private, no-store, must-revalidate, max-stale=0, post-check=0, pre-check=0";
    }

    include snippets/private_PHP72.conf;
 }
